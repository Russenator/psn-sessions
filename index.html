<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PSN Sessionsplaner ‚Äî Timezone Edition</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/de.js"></script>

<style>
:root{
  --bg:#f4f8ff; --card:#ffffff; --text:#0f172a; --accent:#4a8bff; --muted:#6b7280; --border:#e5e7eb;
}
body{ font-family:"Inter", sans-serif; background:var(--bg); margin:0; padding:16px; color:var(--text); font-size: 14px; }

.sticky-top-area {
  position: fixed; top: 0; left: 50%; transform: translateX(-50%);
  width: 100%; max-width: 880px; padding: 16px 16px 0 16px;
  background: var(--bg); z-index: 1000; box-sizing: border-box;
}
.container { max-width:880px; margin:0 auto; padding-top: 230px; }

.header{ display:flex; align-items:center; justify-content: space-between; padding:10px 16px; background:var(--card); border-radius:14px; margin-bottom:12px; box-shadow:0 4px 16px rgba(0,0,0,.08); }
.title{ font-size:22px; font-weight:600; display:flex; align-items:center; gap:10px; }
.title img{ width:28px; height:28px; }

.header-controls { display: flex; gap: 8px; align-items: center; }
#langSelect, #themeBtn{ padding:6px 10px; border-radius:8px; border:1px solid var(--border); background:var(--card); color: inherit; cursor:pointer; height: 36px;}

.card-form { background:var(--card); border-radius:14px; padding:16px; margin-bottom:16px; box-shadow:0 6px 20px rgba(0,0,0,.06); }

.form-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px; align-items: center; }
#name, #game { grid-column: span 6; }
.flatpickr-wrapper { grid-column: span 7; }
#tzoffset { grid-column: span 2; text-align: center; font-weight: 600; }
#saveBtn { grid-column: span 3 !important; }

#saveBtn { 
  background: var(--accent); color: #fff; border: none; border-radius: 10px; 
  height: 40px; display: flex; align-items: center; justify-content: center;
  transition: transform 0.1s; cursor: pointer; font-weight: 600;
}
#saveBtn:active, .delete-all:active, .delete:active, .delete-day:active { transform: scale(0.95); }

.input{ padding:10px; border-radius:10px; border:1px solid var(--border); width: 100%; box-sizing: border-box; min-height: 40px; background: var(--card); color: inherit; outline: none; }

.game-box{ background:#eef4ff; border-radius:14px; padding:12px; margin-bottom:20px; border: 1px solid transparent; }
.game-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 2px 8px; }

.delete-all { background:#ef4444; color:#fff; border:none; border-radius:8px; width:32px; height:32px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition: transform 0.1s;}

.session-group { 
  display: grid; 
  grid-template-columns: repeat(auto-fill, 180px); 
  gap: 10px; 
  padding: 12px 60px 12px 12px; 
  background: #fff; 
  border-radius: 12px; 
  border: 1px solid var(--border); 
  position: relative;
  margin-bottom: 10px; 
}

.group-actions {
  position: absolute; 
  right: 12px; 
  top: 12px; bottom: 12px;
  display: flex; 
  flex-direction: column; 
  justify-content: center; 
  align-items: center; 
  gap: 8px;
}

.count-badge { background:var(--accent); color:#fff; padding:4px 8px; border-radius:30px; font-size:11px; font-weight:bold; white-space: nowrap; }

.session-item { background: linear-gradient(180deg, #f5f9ff, #eaf1ff); border-radius: 10px; padding: 10px 35px 10px 10px; border: 1px solid #dbe5ff; position: relative; min-height: 80px; width: 180px; display: flex; flex-direction: column; justify-content: center; box-sizing: border-box; }

.player-name{ font-weight:600; font-size:14px; margin-bottom: 2px; }
.date, .time{ font-size:13px; color:var(--muted); font-weight: 500; }
.delete, .delete-day{ background:#ef4444; color:#fff; border:none; display:flex; align-items:center; justify-content:center; cursor:pointer; transition: transform 0.1s;}
.delete{ position:absolute; right:6px; top:50%; transform: translateY(-50%); width:20px; height:20px; border-radius:50%; font-size:11px; }
.delete-day{ width:28px; height:28px; border-radius:50%; background:#dc2626; font-size: 18px; }

/* DARKMODE */
.dark{ --bg:#0b1220; --card:#1e293b; --text:#ffffff; --border:#334155; --muted:#ffffff; }
.dark .sticky-top-area { background: #0b1220; }
.dark .game-box{ background:#161f2e !important; border: 1px solid #334155 !important; }
.dark .session-group{ background:#0f172a; border-color: #1e293b; }
.dark .input { background: linear-gradient(180deg, #334155, #1e293b) !important; color: #ffffff !important; border-color: #475569 !important; }

.dark .input::placeholder { color: rgba(255, 255, 255, 0.8) !important; opacity: 1; }
.dark .input::-webkit-input-placeholder { color: rgba(255, 255, 255, 0.8) !important; }
.dark .input::-moz-placeholder { color: rgba(255, 255, 255, 0.8) !important; }

.dark .session-item { background: linear-gradient(180deg, #334155, #1e293b); border-color:#475569; }
.dark .player-name { color: #0ea5e9; }
</style>
</head>
<body>

<div class="sticky-top-area">
  <div class="header">
    <div class="title" id="titleEl"><img src="https://www.clipartmax.com/png/small/120-1209857_free-psn-code-generator-logo-playstation-network.png"> PSN Sessionsplaner</div>
    <div class="header-controls">
      <select id="langSelect"><option value="de">Deutsch</option><option value="en">English</option></select>
      <button id="themeBtn">‚òÄÔ∏è</button>
    </div>
  </div>
  <div class="card-form">
    <form class="form-grid" onsubmit="return false;">
      <input id="name" class="input" placeholder="Name">
      <input id="game" class="input" placeholder="Spiel">
      <div class="flatpickr-wrapper" id="fp-container"><input id="dateRange" class="input" placeholder="Datum & Zeit"></div>
      <input id="tzoffset" class="input" placeholder="UTC">
      <button id="saveBtn">üíæ</button>
    </form>
  </div>
</div>

<div class="container">
  <div id="sessions"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = { apiKey: "AIzaSyBu7TsiZAGJ7kQ8piqfrsyUFalEOM8eSGU", authDomain: "psn-planen.firebaseapp.com", projectId: "psn-planen" };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const colRef = collection(db, "sessions");

let fp;

// ZEITZONE AUTOMATISCH ERMITTELN
function detectTimezone() {
  const offset = -new Date().getTimezoneOffset() / 60;
  const sign = offset >= 0 ? "+" : "";
  document.getElementById("tzoffset").value = sign + offset;
}

function initFlatpickr(lang = 'de') {
  const container = document.getElementById('fp-container');
  const ph = lang === 'de' ? "Datum & Zeit" : "Date & Time";
  container.innerHTML = `<input id="dateRange" class="input" placeholder="${ph}">`;
  fp = flatpickr("#dateRange", { 
    locale: lang === 'de' ? flatpickr.l10ns.de : "default", 
    enableTime: true, time_24hr: true, mode: "range", altInput: true, altFormat: "d.m.Y H:i"
  });
}

function updateUIText(lang) {
  const de = lang === "de";
  titleEl.innerHTML = `<img src="https://www.clipartmax.com/png/small/120-1209857_free-psn-code-generator-logo-playstation-network.png"> ${de ? "PSN Sessionsplaner" : "PSN Session Planner"}`;
  document.getElementById("name").placeholder = de ? "Name" : "Name";
  document.getElementById("game").placeholder = de ? "Spiel" : "Game";
}

// Initialer Start
const userLang = navigator.language || navigator.userLanguage;
const startLang = userLang.startsWith("en") ? "en" : "de";

langSelect.value = startLang;
updateUIText(startLang);
initFlatpickr(startLang);
detectTimezone(); // <--- Hier wird UTC automatisch ausgef√ºllt

themeBtn.onclick = () => {
  document.documentElement.classList.toggle("dark");
  themeBtn.textContent = document.documentElement.classList.contains("dark") ? "üåô" : "‚òÄÔ∏è";
};

langSelect.onchange = () => {
  updateUIText(langSelect.value);
  initFlatpickr(langSelect.value);
  renderSessions();
};

async function renderSessions() {
  const sessionsDiv = document.getElementById("sessions");
  const isDe = langSelect.value === "de";
  sessionsDiv.innerHTML = `<p style="text-align:center;">${isDe ? "Lade Sessions..." : "Loading sessions..."}</p>`;
  
  try {
    const snap = await getDocs(colRef);
    if (snap.empty) { sessionsDiv.innerHTML = ""; return; }
    const data = snap.docs.map(d => ({ ...d.data(), id: d.id }));
    const grouped = {};
    
    data.forEach(s => {
      if (!grouped[s.game]) grouped[s.game] = {};
      if (!grouped[s.game][s.date]) grouped[s.game][s.date] = [];
      grouped[s.game][s.date].push(s);
    });

    sessionsDiv.innerHTML = "";
    Object.keys(grouped).sort().forEach(gameName => {
      const box = document.createElement("div");
      box.className = "game-box";
      box.innerHTML = `<div class="game-title">
          <span style="font-size:18px;font-weight:600;">${gameName}</span>
          <button class="delete-all">üóëÔ∏è</button>
        </div>`;
      
      box.querySelector(".delete-all").onclick = async () => {
        if (prompt("Admin-Key:") !== "Grandia2025") return;
        const q = query(colRef, where("game", "==", gameName));
        const qs = await getDocs(q);
        for (const d of qs.docs) await deleteDoc(doc(db, "sessions", d.id));
        renderSessions();
      };

      Object.keys(grouped[gameName]).sort((a,b) => a.split('.').reverse().join('-').localeCompare(b.split('.').reverse().join('-'))).forEach(dateStr => {
        const groupDiv = document.createElement("div");
        groupDiv.className = "session-group";
        
        const actionsDiv = document.createElement("div");
        actionsDiv.className = "group-actions";
        actionsDiv.innerHTML = `<span class="count-badge">üë• ${grouped[gameName][dateStr].length}</span>`;
        
        const delDay = document.createElement("button");
        delDay.className = "delete-day";
        delDay.textContent = "√ó";
        delDay.onclick = async () => {
          if (prompt("Admin-Key:") !== "Grandia2025") return;
          for (const s of grouped[gameName][dateStr]) await deleteDoc(doc(db, "sessions", s.id));
          renderSessions();
        };
        actionsDiv.appendChild(delDay);
        groupDiv.appendChild(actionsDiv);

        grouped[gameName][dateStr].sort((a, b) => a.from.localeCompare(b.from)).forEach(s => {
          const item = document.createElement("div");
          item.className = "session-item";
          // HIER ZEIGEN WIR DIE ZEITZONE JETZT AUCH BEI JEDEM EINTRAG AN
          const tzDisplay = s.tz ? ` <small>(${s.tz})</small>` : "";
          item.innerHTML = `<div class="player-name">üéÆ ${s.name}</div><div class="date">üìÖ ${s.date}</div><div class="time">‚è∞ ${s.from} ‚Äì ${s.to}${tzDisplay}</div>`;
          const delBtn = document.createElement("button"); delBtn.className = "delete"; delBtn.textContent = "√ó";
          delBtn.onclick = async () => {
            if (prompt("Admin-Key:") !== "Grandia2025") return;
            await deleteDoc(doc(db, "sessions", s.id));
            renderSessions();
          };
          item.appendChild(delBtn);
          groupDiv.appendChild(item);
        });
        box.appendChild(groupDiv);
      });
      sessionsDiv.appendChild(box);
    });
  } catch (e) { console.error(e); }
}

saveBtn.onclick = async () => {
  const de = langSelect.value === "de";
  const nameInput = document.getElementById("name");
  const gameInput = document.getElementById("game");
  if (fp.selectedDates.length !== 2) return alert(de ? "Bitte Zeitraum w√§hlen" : "Please select range");
  if (!nameInput.value.trim() || !gameInput.value.trim()) return alert(de ? "Bitte Name und Spiel eingeben" : "Missing info");
  
  const [start, end] = fp.selectedDates;
  let cur = new Date(start); cur.setHours(0,0,0,0);
  let last = new Date(end); last.setHours(0,0,0,0);
  
  while (cur <= last) {
    await addDoc(colRef, {
      name: nameInput.value.trim(),
      game: gameInput.value.trim(),
      date: cur.toLocaleDateString("de-DE"),
      from: start.toTimeString().slice(0, 5),
      to: end.toTimeString().slice(0, 5),
      tz: document.getElementById("tzoffset").value.trim()
    });
    cur.setDate(cur.getDate() + 1);
  }
  
  nameInput.value = ""; gameInput.value = ""; fp.clear(); renderSessions();
};
renderSessions();
</script>
</body>
</html>
