<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aktuelle Sitzungen</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #e8f0ff, #f8fbff);
      color: #222;
      margin: 0;
      padding: 20px;
      transition: background 0.3s, color 0.3s;
    }
    h1 {
      text-align: center;
      font-size: 2rem;
      margin-bottom: 10px;
    }
    .theme-toggle {
      display: block;
      margin: 0 auto 20px auto;
      padding: 10px 20px;
      background: #4a8bff;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 0 10px #4a8bff88;
      transition: box-shadow 0.3s;
    }
    .theme-toggle:hover {
      box-shadow: 0 0 20px #4a8bffcc;
    }
    .card {
      background: #fff;
      padding: 24px;
      border-radius: 20px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
      max-width: 600px;
      margin: 20px auto;
      transition: background 0.3s, box-shadow 0.3s;
    }
    .form-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .form-row input {
      flex: 1 1 120px;
      padding: 8px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 0.95rem;
      transition: background 0.3s, border-color 0.3s, color 0.3s;
    }
    .form-row button.submit {
      flex: 0 0 auto;
      padding: 8px 16px;
      font-weight: bold;
      background: #4a8bff;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 0 8px #4a8bffaa;
      transition: box-shadow 0.3s;
    }
    .form-row button.submit:hover {
      box-shadow: 0 0 15px #4a8bffcc;
    }
    .list-item {
      max-width: 500px;
      padding: 10px;
      margin: 10px auto;
      border-radius: 12px;
      background: #f5f8ff;
      border: 1px solid #e2e8f0;
      transition: 0.25s;
      font-size: 0.95rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .list-item:hover {
      background: #e1efff;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px #4a8bff66;
    }
    .delete-btn {
      background: #ff4a4a;
      color: white;
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      font-weight: bold;
      cursor: pointer;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      box-shadow: 0 0 10px #ff4a4aaa;
      transition: box-shadow 0.3s;
    }
    .delete-btn:hover {
      box-shadow: 0 0 15px #ff4a4aff;
    }
    .empty-text {
      text-align: center;
      padding: 20px;
      color: #777;
    }
    /* Dark mode */
    .dark {
      background: #1a1a1a;
      color: #eaeaea;
    }
    .dark .card {
      background: #262626;
      box-shadow: 0 6px 20px rgba(0,0,0,0.8);
    }
    .dark input {
      background: #262626;
      color: #eaeaea;
      border: 1px solid #444;
    }
    .dark .list-item {
      background: #333;
      border: 1px solid #444;
    }
    /* Kalender & Uhr Styles */
    #date, #tzoffset {
      cursor: pointer;
    }
    /* Popup f√ºr analoge Uhr */
    .popup {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(-10px);
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 8px 30px rgba(74,139,255,0.4);
      padding: 15px;
      margin-top: 5px;
      opacity: 0;
      pointer-events: none;
      user-select: none;
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 10;
      width: 280px;
    }
    .dark .popup {
      background: #262626;
      box-shadow: 0 8px 30px rgba(74,139,255,0.8);
    }
    .popup.show {
      opacity: 1;
      pointer-events: auto;
      transform: translateX(-50%) translateY(0);
    }
  </style>
</head>
<body>
<h1 id="title">Aktuelle Sitzungen</h1>
<button class="theme-toggle" onclick="toggleTheme()">üåô / ‚òÄÔ∏è</button>

<!-- Formular f√ºr neue Sitzung -->
<div class="card">
  <h2 id="newSessionTitle">Neue Sitzung hinzuf√ºgen</h2>
  <div class="form-row">
    <input id="name" placeholder="" autocomplete="off" />
    <input id="game" placeholder="" autocomplete="off" />
    <input id="timerange" placeholder="" autocomplete="off" />
  </div>
  <div class="form-row">
    <div style="position:relative; flex: 1 1 120px;">
      <input id="date" placeholder="" readonly />
    </div>
    <div style="position:relative; flex: 1 1 120px;">
      <input id="tzoffset" placeholder="" autocomplete="off" />
    </div>
    <button class="submit" onclick="addSession()" id="saveBtn"></button>
  </div>

  <div style="margin-top: 20px; text-align: center;">
    <button onclick="toggleClockPopup()" style="background:#4a8bff; color:white; border:none; border-radius:12px; padding:8px 20px; cursor:pointer; box-shadow:0 0 12px #4a8bffaa; font-weight:bold;">
      Uhrzeit w√§hlen ‚è∞
    </button>
  </div>

  <!-- Analoge Uhr -->
  <div id="clock-popup" class="popup">
    <canvas id="clock-canvas" width="260" height="260" style="display:block;margin:0 auto;"></canvas>
    <div style="text-align:center; margin-top:10px;">
      <button onclick="applyTime()" style="padding:8px 20px; border:none; border-radius:12px; background:#4a8bff; color:white; font-weight:bold; cursor:pointer; box-shadow:0 0 12px #4a8bffaa;">Speichern</button>
      <button onclick="toggleClockPopup()" style="padding:8px 20px; border:none; border-radius:12px; background:#ccc; color:#333; font-weight:bold; cursor:pointer; margin-left:10px;">Abbrechen</button>
    </div>
  </div>
</div>

<!-- Verf√ºgbarkeitsliste -->
<div class="card">
  <h2 id="availabilityListTitle">Verf√ºgbarkeitsliste</h2>
  <div id="list">Wird geladen...</div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />

<script>
// --- Admin, Sprache, √úbersetzungen ---
const ADMIN_KEY="MEIN_GEHEIM_KEY";
let isAdmin=false;
const lang=navigator.language||navigator.userLanguage||"de";
const uiLang=lang.startsWith("de")?"de":lang.startsWith("es")?"es":"en";
const translations={
  de:{namePlaceholder:"Name (PSN)",gamePlaceholder:"Spiel",timerangePlaceholder:"Zeitraum (z.B. 8-12)",datePlaceholder:"Datum ausw√§hlen",tzoffsetPlaceholder:"UTC-Offset",newSessionTitle:"Neue Sitzung hinzuf√ºgen",availabilityListTitle:"Verf√ºgbarkeitsliste",saveButton:"Speichern",adminPrompt:"Admin-Schl√ºssel eingeben (nur wenn du l√∂schen willst):",deleteConfirm:"Willst du diese Sitzung wirklich l√∂schen?"},
  en:{namePlaceholder:"Name (PSN)",gamePlaceholder:"Game",timerangePlaceholder:"Time range (e.g. 8-12)",datePlaceholder:"Select date",tzoffsetPlaceholder:"UTC offset",newSessionTitle:"Add new session",availabilityListTitle:"Availability list",saveButton:"Save",adminPrompt:"Enter admin key (only for deleting):",deleteConfirm:"Do you really want to delete this session?"},
  es:{namePlaceholder:"Nombre (PSN)",gamePlaceholder:"Juego",timerangePlaceholder:"Rango horario (p.ej. 8-12)",datePlaceholder:"Seleccionar fecha",tzoffsetPlaceholder:"Desfase UTC",newSessionTitle:"Agregar sesi√≥n nueva",availabilityListTitle:"Lista de disponibilidad",saveButton:"Guardar",adminPrompt:"Ingrese clave de administrador (solo para borrar):",deleteConfirm:"¬øRealmente deseas eliminar esta sesi√≥n?"}
};
document.getElementById("name").placeholder=translations[uiLang].namePlaceholder;
document.getElementById("game").placeholder=translations[uiLang].gamePlaceholder;
document.getElementById("timerange").placeholder=translations[uiLang].timerangePlaceholder;
document.getElementById("date").placeholder=translations[uiLang].datePlaceholder;
document.getElementById("tzoffset").placeholder=translations[uiLang].tzoffsetPlaceholder;
document.getElementById("newSessionTitle").textContent=translations[uiLang].newSessionTitle;
document.getElementById("availabilityListTitle").textContent=translations[uiLang].availabilityListTitle;
document.getElementById("saveBtn").textContent=translations[uiLang].saveButton;

// --- Firebase ---
const firebaseConfig = {
  apiKey: "AIzaSyBu7TsiZAGJ7kQ8piqfrsyUFalEOM8eSGU",
  authDomain: "psn-planen.firebaseapp.com",
  projectId: "psn-planen",
  storageBucket: "psn-planen.firebasestorage.app",
  messagingSenderId: "1089591052960",
  appId: "1:1089591052960:web:069c515084f2105b22d7c5"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

// --- Dark Mode ---
function toggleTheme(){document.body.classList.toggle('dark');}

// --- Kalender ---
flatpickr(document.getElementById("date"),{dateFormat:"Y-m-d",locale:uiLang,weekStart:(uiLang==="de"||uiLang==="es")?1:0});

// --- Analoge Uhr mit Drag & Drop ---
let clockPopup=document.getElementById("clock-popup");
let clockVisible=false;
let canvas=document.getElementById("clock-canvas");
let ctx=canvas.getContext("2d");
let clockRadius=120, centerX=canvas.width/2, centerY=canvas.height/2;
let selectedHour=0, selectedMinute=0, dragging=null;
const minutesArr=[0,15,30,45];

function drawClock(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // Kreis
  ctx.beginPath();
  ctx.arc(centerX,centerY,clockRadius,0,2*Math.PI);
  ctx.fillStyle=document.body.classList.contains("dark")?"#262626":"#f0f4ff";
  ctx.fill();
  ctx.lineWidth=4;
  ctx.strokeStyle=document.body.classList.contains("dark")?"#444":"#4a8bff";
  ctx.stroke();

  // Stundenmarkierungen
  for(let i=0;i<24;i++){
    let angle=(i/24)*2*Math.PI-Math.PI/2;
    let x=centerX+Math.cos(angle)*(clockRadius-20);
    let y=centerY+Math.sin(angle)*(clockRadius-20);
    ctx.fillStyle=(i===selectedHour)?"#4a8bff":(document.body.classList.contains("dark")?"#eaeaea":"#222");
    ctx.font="14px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle";
    ctx.fillText(i.toString().padStart(2,"0"),x,y);
  }

  // Minutenmarkierungen
  minutesArr.forEach(m=>{
    let angle=(m/60)*2*Math.PI-Math.PI/2;
    let x=centerX+Math.cos(angle)*(clockRadius-50);
    let y=centerY+Math.sin(angle)*(clockRadius-50);
    ctx.fillStyle=(m===selectedMinute)?"#4a8bff":(document.body.classList.contains("dark")?"#eaeaea":"#222");
    ctx.fillText(m.toString().padStart(2,"0"),x,y);
  });

  // Stundenzeiger
  let hourAngle=(selectedHour/24)*2*Math.PI-Math.PI/2;
  ctx.beginPath(); ctx.moveTo(centerX,centerY);
  ctx.lineTo(centerX+Math.cos(hourAngle)*(clockRadius-60),centerY+Math.sin(hourAngle)*(clockRadius-60));
  ctx.lineWidth=6; ctx.strokeStyle="#4a8bff"; ctx.stroke();

  // Minutenzeiger
  let minAngle=(selectedMinute/60)*2*Math.PI-Math.PI/2;
  ctx.beginPath(); ctx.moveTo(centerX,centerY);
  ctx.lineTo(centerX+Math.cos(minAngle)*(clockRadius-30),centerY+Math.sin(minAngle)*(clockRadius-30));
  ctx.lineWidth=4; ctx.strokeStyle="#ff6a6a"; ctx.stroke();
}

// --- Drag & Drop ---
canvas.addEventListener("mousedown",(e)=>{
  dragging=true; updateTimeFromMouse(e);
});
canvas.addEventListener("mousemove",(e)=>{if(dragging) updateTimeFromMouse(e);});
canvas.addEventListener("mouseup",(e)=>{dragging=false;});
canvas.addEventListener("mouseleave",(e)=>{dragging=false;});

function updateTimeFromMouse(e){
  let rect=canvas.getBoundingClientRect();
  let x=e.clientX-rect.left-centerX;
  let y=e.clientY-rect.top-centerY;
  let angle=Math.atan2(y,x)+Math.PI/2; if(angle<0) angle+=2*Math.PI;
  let distance=Math.sqrt(x*x+y*y);

  if(distance>clockRadius-60){ // Stundenbereich
    selectedHour=Math.round((angle/(2*Math.PI))*24)%24;
  }else{ // Minutenbereich
    let m=Math.round((angle/(2*Math.PI))*60/15)*15%60;
    selectedMinute=m;
  }
  drawClock();
}

// --- Zeit √ºbernehmen ---
function applyTime(){
  document.getElementById("timerange").value=
    `${selectedHour.toString().padStart(2,"0")}:${selectedMinute.toString().padStart(2,"0")}`;
  toggleClockPopup();
}

// --- Popup ---
function toggleClockPopup(){
  clockVisible=!clockVisible;
  clockPopup.classList.toggle("show",clockVisible);
  if(clockVisible) drawClock();
}

// --- Sitzung hinzuf√ºgen ---
async function addSession(){
  const name=document.getElementById('name').value.trim();
  const game=document.getElementById('game').value.trim();
  const timerange=document.getElementById('timerange').value.trim();
  const tzoffset=parseFloat(document.getElementById('tzoffset').value.trim());
  if(!name||!game||!timerange||isNaN(tzoffset)){
    alert(uiLang==="de"?"Bitte alle Felder ausf√ºllen!":"Please fill all fields!");
    return;
  }
  await db.collection('entries').add({name,game,timerange,tzoffset});
  document.getElementById('name').value='';
  document.getElementById('game').value='';
  document.getElementById('timerange').value='';
  document.getElementById('tzoffset').value='';
  loadSessions();
}

// --- Sitzungen laden ---
async function loadSessions(){
  const snapshot=await db.collection('entries').get();
  const listEl=document.getElementById("list"); listEl.innerHTML='';
  if(snapshot.empty){listEl.innerHTML='Keine Sitzungen gefunden.'; return;}
  snapshot.forEach(doc=>{
    const data=doc.data();
    const item=document.createElement('div'); item.className='list-item';
    item.innerHTML=`<div><strong>${data.name}</strong> ‚Äî ${data.game}<br>Zeit: ${data.timerange} (UTC${data.tzoffset>=0?'+':''}${data.tzoffset})</div>`;
    listEl.appendChild(item);
  });
}

// --- Init ---
loadSessions();
</script>
</body>
</html>
