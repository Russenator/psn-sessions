<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aktuelle Sitzungen</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #e8f0ff, #f8fbff);
      color: #222;
      margin: 0;
      padding: 20px;
      transition: background 0.3s, color 0.3s;
    }
    h1 {
      text-align: center;
      font-size: 2rem;
      margin-bottom: 10px;
    }
    .theme-toggle {
      display: block;
      margin: 0 auto 20px auto;
      padding: 10px 20px;
      background: #4a8bff;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 0 10px #4a8bff88;
      transition: box-shadow 0.3s;
    }
    .theme-toggle:hover {
      box-shadow: 0 0 20px #4a8bffcc;
    }
    .card {
      background: #fff;
      padding: 24px;
      border-radius: 20px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
      max-width: 600px;
      margin: 20px auto;
      transition: background 0.3s, box-shadow 0.3s;
    }
    .form-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .form-row input {
      flex: 1 1 120px;
      padding: 8px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 0.95rem;
      transition: background 0.3s, border-color 0.3s, color 0.3s;
    }
    .form-row button.submit {
      flex: 0 0 auto;
      padding: 8px 16px;
      font-weight: bold;
      background: #4a8bff;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 0 8px #4a8bffaa;
      transition: box-shadow 0.3s;
    }
    .form-row button.submit:hover {
      box-shadow: 0 0 15px #4a8bffcc;
    }
    .list-item {
      max-width: 500px;
      padding: 10px;
      margin: 10px auto;
      border-radius: 12px;
      background: #f5f8ff;
      border: 1px solid #e2e8f0;
      transition: 0.25s;
      font-size: 0.95rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .list-item:hover {
      background: #e1efff;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px #4a8bff66;
    }
    .delete-btn {
      background: #ff4a4a;
      color: white;
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      font-weight: bold;
      cursor: pointer;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      box-shadow: 0 0 10px #ff4a4aaa;
      transition: box-shadow 0.3s;
    }
    .delete-btn:hover {
      box-shadow: 0 0 15px #ff4a4aff;
    }
    .empty-text {
      text-align: center;
      padding: 20px;
      color: #777;
    }
    /* Dark mode */
    .dark {
      background: #1a1a1a;
      color: #eaeaea;
    }
    .dark .card {
      background: #262626;
      box-shadow: 0 6px 20px rgba(0,0,0,0.8);
    }
    .dark input {
      background: #262626;
      color: #eaeaea;
      border: 1px solid #444;
    }
    .dark .list-item {
      background: #333;
      border: 1px solid #444;
    }
    /* Kalender & Uhr Styles */
    #date, #tzoffset {
      cursor: pointer;
    }
    /* Analoge Uhr Container */
    .clock-container {
      position: relative;
      width: 260px;
      height: 260px;
      margin: 20px auto;
      background: linear-gradient(145deg, #f0f4ff, #d9e2ff);
      border-radius: 50%;
      box-shadow:
        8px 8px 16px #b8c6ff,
        -8px -8px 16px #ffffff;
      user-select: none;
    }
    .dark .clock-container {
      background: linear-gradient(145deg, #2a2a2a, #3a3a3a);
      box-shadow:
        8px 8px 16px #1a1a1a,
        -8px -8px 16px #444444;
    }
    .clock-number {
      position: absolute;
      font-weight: 600;
      font-size: 1.15rem;
      color: #222;
      user-select: none;
      transition: color 0.3s, transform 0.2s;
      width: 30px;
      height: 30px;
      text-align: center;
      line-height: 30px;
      border-radius: 50%;
      cursor: pointer;
    }
    .dark .clock-number {
      color: #eaeaea;
    }
    .clock-number:hover {
      color: #4a8bff;
      transform: scale(1.3);
      font-weight: 700;
      text-shadow: 0 0 8px #4a8bffaa;
    }
    /* Auswahlanzeige */
    .selected {
      background-color: #4a8bffcc;
      color: white !important;
      box-shadow: 0 0 8px #4a8bffdd;
    }
    /* Eingabefelder f√ºr Uhrzeit */
    .time-inputs {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    .time-inputs > div {
      text-align: center;
    }
    .time-inputs label {
      display: block;
      font-weight: 600;
      margin-bottom: 5px;
      user-select: none;
    }
    .time-inputs input, .time-inputs select {
      padding: 8px 12px;
      font-size: 1rem;
      border-radius: 10px;
      border: 1px solid #ccc;
      width: 80px;
      text-align: center;
      cursor: pointer;
      transition: background 0.3s, border-color 0.3s, color 0.3s;
    }
    .dark .time-inputs input, .dark .time-inputs select {
      background: #262626;
      color: #eaeaea;
      border: 1px solid #444;
    }
    /* Animation Popup f√ºr Kalender & Uhr */
    .popup {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(-10px);
      background: #fff;
      border-radius: 20px;
      box-shadow:
        0 8px 30px rgba(74, 139, 255, 0.4);
      padding: 15px;
      margin-top: 5px;
      opacity: 0;
      pointer-events: none;
      user-select: none;
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 10;
      width: 280px;
    }
    .dark .popup {
      background: #262626;
      box-shadow: 0 8px 30px rgba(74, 139, 255, 0.8);
    }
    .popup.show {
      opacity: 1;
      pointer-events: auto;
      transform: translateX(-50%) translateY(0);
    }
  </style>
</head>
<body>
  <h1 id="title">Aktuelle Sitzungen</h1>
  <button class="theme-toggle" onclick="toggleTheme()">üåô / ‚òÄÔ∏è</button>

  <!-- Formular f√ºr neue Sitzung -->
  <div class="card">
    <h2 id="newSessionTitle">Neue Sitzung hinzuf√ºgen</h2>
    <div class="form-row">
      <input id="name" placeholder="" autocomplete="off" />
      <input id="game" placeholder="" autocomplete="off" />
      <input id="timerange" placeholder="" autocomplete="off" />
    </div>
    <div class="form-row">
      <div style="position:relative; flex: 1 1 120px;">
        <input id="date" placeholder="" readonly />
        <div id="date-popup" class="popup"></div>
      </div>
      <div style="position:relative; flex: 1 1 120px;">
        <input id="tzoffset" placeholder="" autocomplete="off" />
      </div>
      <button class="submit" onclick="addSession()" id="saveBtn"></button>
    </div>

    <div style="margin-top: 20px; text-align: center;">
      <button onclick="toggleClockPopup()" style="background:#4a8bff; color:white; border:none; border-radius:12px; padding:8px 20px; cursor:pointer; box-shadow:0 0 12px #4a8bffaa; font-weight:bold;">
        Uhrzeit w√§hlen ‚è∞
      </button>
    </div>

    <div id="clock-popup" class="popup" style="width:280px; height:280px; padding:10px;">
      <div class="clock-container" id="clock-container"></div>
      <div class="time-inputs">
        <div>
          <label for="hour-input" id="labelStartTime"></label>
          <input type="number" id="hour-input" min="0" max="23" />
        </div>
        <div>
          <label for="minute-input" id="labelEndTime"></label>
          <input type="number" id="minute-input" step="15" min="0" max="59" />
        </div>
        <div id="am-pm-container" style="display:none;">
          <label for="am-pm-select">AM/PM</label>
          <select id="am-pm-select">
            <option value="AM">AM</option>
            <option value="PM">PM</option>
          </select>
        </div>
      </div>
      <div style="text-align:center; margin-top:10px;">
        <button onclick="applyTime()" style="padding:8px 20px; border:none; border-radius:12px; background:#4a8bff; color:white; font-weight:bold; cursor:pointer; box-shadow:0 0 12px #4a8bffaa;">
          Speichern
        </button>
        <button onclick="toggleClockPopup()" style="padding:8px 20px; border:none; border-radius:12px; background:#ccc; color:#333; font-weight:bold; cursor:pointer; margin-left:10px;">
          Abbrechen
        </button>
      </div>
    </div>
  </div>

  <!-- Verf√ºgbarkeitsliste -->
  <div class="card">
    <h2 id="availabilityListTitle">Verf√ºgbarkeitsliste</h2>
    <div id="list">Wird geladen...</div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />

  <script>
    // Admin-Schl√ºssel
    const ADMIN_KEY = "MEIN_GEHEIM_KEY";
    let isAdmin = false;

    // Sprache automatisch erkennen (Deutsch, Englisch, Spanisch)
    const lang = navigator.language || navigator.userLanguage || "de";
    const uiLang = lang.startsWith("de") ? "de" : lang.startsWith("es") ? "es" : "en";

    // √úbersetzungen (einfach gehalten)
    const translations = {
      de: {
        namePlaceholder: "Name (PSN)",
        gamePlaceholder: "Spiel",
        timerangePlaceholder: "Zeitraum (z.B. 8-12)",
        datePlaceholder: "Datum ausw√§hlen",
        tzoffsetPlaceholder: "UTC-Offset",
        newSessionTitle: "Neue Sitzung hinzuf√ºgen",
        availabilityListTitle: "Verf√ºgbarkeitsliste",
        saveButton: "Speichern",
        startTimeLabel: "Startzeit",
        endTimeLabel: "Endzeit",
        adminPrompt: "Admin-Schl√ºssel eingeben (nur wenn du l√∂schen willst):",
        deleteConfirm: "Willst du diese Sitzung wirklich l√∂schen?",
        am: "AM",
        pm: "PM",
        chooseTimeBtn: "Uhrzeit w√§hlen ‚è∞",
        cancel: "Abbrechen"
      },
      en: {
        namePlaceholder: "Name (PSN)",
        gamePlaceholder: "Game",
        timerangePlaceholder: "Time range (e.g. 8-12)",
        datePlaceholder: "Select date",
        tzoffsetPlaceholder: "UTC offset",
        newSessionTitle: "Add new session",
        availabilityListTitle: "Availability list",
        saveButton: "Save",
        startTimeLabel: "Start time",
        endTimeLabel: "End time",
        adminPrompt: "Enter admin key (only for deleting):",
        deleteConfirm: "Do you really want to delete this session?",
        am: "AM",
        pm: "PM",
        chooseTimeBtn: "Choose time ‚è∞",
        cancel: "Cancel"
      },
      es: {
        namePlaceholder: "Nombre (PSN)",
        gamePlaceholder: "Juego",
        timerangePlaceholder: "Rango horario (p.ej. 8-12)",
        datePlaceholder: "Seleccionar fecha",
        tzoffsetPlaceholder: "Desfase UTC",
        newSessionTitle: "Agregar sesi√≥n nueva",
        availabilityListTitle: "Lista de disponibilidad",
        saveButton: "Guardar",
        startTimeLabel: "Hora de inicio",
        endTimeLabel: "Hora de fin",
        adminPrompt: "Ingrese clave de administrador (solo para borrar):",
        deleteConfirm: "¬øRealmente deseas eliminar esta sesi√≥n?",
        am: "AM",
        pm: "PM",
        chooseTimeBtn: "Elegir hora ‚è∞",
        cancel: "Cancelar"
      }
    };

    // UI Texte setzen
    function setUIText() {
      document.getElementById("name").placeholder = translations[uiLang].namePlaceholder;
      document.getElementById("game").placeholder = translations[uiLang].gamePlaceholder;
      document.getElementById("timerange").placeholder = translations[uiLang].timerangePlaceholder;
      document.getElementById("date").placeholder = translations[uiLang].datePlaceholder;
      document.getElementById("tzoffset").placeholder = translations[uiLang].tzoffsetPlaceholder;
      document.getElementById("newSessionTitle").textContent = translations[uiLang].newSessionTitle;
      document.getElementById("availabilityListTitle").textContent = translations[uiLang].availabilityListTitle;
      document.getElementById("saveBtn").textContent = translations[uiLang].saveButton;
      document.getElementById("labelStartTime").textContent = translations[uiLang].startTimeLabel;
      document.getElementById("labelEndTime").textContent = translations[uiLang].endTimeLabel;
      document.querySelector(".theme-toggle").textContent = uiLang === "de" ? "üåô / ‚òÄÔ∏è" : uiLang === "es" ? "üåô / ‚òÄÔ∏è" : "üåô / ‚òÄÔ∏è";
    }
    setUIText();

    // Firebase-Konfiguration
    const firebaseConfig = {
      apiKey: "AIzaSyBu7TsiZAGJ7kQ8piqfrsyUFalEOM8eSGU",
      authDomain: "psn-planen.firebaseapp.com",
      projectId: "psn-planen",
      storageBucket: "psn-planen.firebasestorage.app",
      messagingSenderId: "1089591052960",
      appId: "1:1089591052960:web:069c515084f2105b22d7c5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Dark Mode umschalten
    function toggleTheme() {
      document.body.classList.toggle('dark');
    }

    // Flatpickr Kalender initialisieren mit Wochenstart Montag f√ºr de & es, Sonntag f√ºr en
    const dateInput = document.getElementById("date");
    flatpickr(dateInput, {
      dateFormat: "Y-m-d",
      locale: uiLang,
      weekStart: (uiLang === "de" || uiLang === "es") ? 1 : 0,
      onChange: (selectedDates) => {
        // Keine Aktion n√∂tig, das Feld ist readonly und √ºbernimmt das Datum automatisch
      }
    });

    // Analoge Uhr mit Stunden au√üen und Minuten innen
    const clockContainer = document.getElementById("clock-container");
    let selectedHour = 0;
    let selectedMinute = 0;
    let useAMPM = uiLang === "en"; // nur Englisch = AM/PM

    function placeNumbers(circle, isHour) {
      circle.innerHTML = "";
      if (isHour) {
        const count = useAMPM ? 12 : 24;
        for (let i = 0; i < count; i++) {
          const angle = (i / count) * 2 * Math.PI - Math.PI / 2;
          const x = Math.cos(angle) * 120 + 130;
          const y = Math.sin(angle) * 120 + 130;
          const num = document.createElement("div");
          num.className = "clock-number";
          const hour = useAMPM ? (i === 0 ? 12 : i) : i;
          num.textContent = useAMPM ? hour : i.toString().padStart(2, "0");
          num.style.left = x + "px";
          num.style.top = y + "px";
          num.onclick = () => {
            selectedHour = useAMPM ? (hour % 12) : hour;
            updateSelection();
          };
          circle.appendChild(num);
        }
      } else {
        const minutes = [15, 30, 45, 0];
        minutes.forEach((min, i) => {
          const angle = (i / minutes.length) * 2 * Math.PI - Math.PI / 2;
          const x = Math.cos(angle) * 70 + 130;
          const y = Math.sin(angle) * 70 + 130;
          const num = document.createElement("div");
          num.className = "clock-number";
          num.textContent = min.toString().padStart(2, "0");
          num.style.left = x + "px";
          num.style.top = y + "px";
          num.onclick = () => {
            selectedMinute = min;
            updateSelection();
          };
          circle.appendChild(num);
        });
      }
    }

    function updateSelection() {
      // Entferne vorherige Selektierung
      [...clockContainer.querySelectorAll(".clock-number")].forEach(el => el.classList.remove("selected"));

      // Stunden markieren
      const hourCount = useAMPM ? 12 : 24;
      for(let i=0; i<hourCount; i++) {
        const hour = useAMPM ? (i === 0 ? 12 : i) : i;
        if (hour === (useAMPM ? (selectedHour === 0 ? 12 : selectedHour) : selectedHour)) {
          clockContainer.children[i].classList.add("selected");
          break;
        }
      }
      // Minuten markieren (nach Stunden)
      const minuteOffset = useAMPM ? 12 : 24;
      const minutes = [15, 30, 45, 0];
      minutes.forEach((min, i) => {
        if (min === selectedMinute) {
          clockContainer.children[minuteOffset + i].classList.add("selected");
        }
      });

      // Eingabefelder aktualisieren
      const hourInput = document.getElementById("hour-input");
      const minuteInput = document.getElementById("minute-input");
      hourInput.value = useAMPM ? (selectedHour === 0 ? 12 : selectedHour) : selectedHour;
      minuteInput.value = selectedMinute;

      // AM/PM Dropdown setzen
      if (useAMPM) {
        const amPmSelect = document.getElementById("am-pm-select");
        const amPmContainer = document.getElementById("am-pm-container");
        amPmContainer.style.display = "block";
        amPmSelect.value = selectedHour >= 12 ? "PM" : "AM";
      }
    }

    // Popup f√ºr Uhrzeit zeigen/verstecken
    const clockPopup = document.getElementById("clock-popup");
    let clockVisible = false;
    function toggleClockPopup() {
      if (clockVisible) {
        clockPopup.classList.remove("show");
        clockVisible = false;
      } else {
        placeNumbers(clockContainer, true);
        placeNumbers(clockContainer, false);
        // Initial Werte
        selectedHour = 0;
        selectedMinute = 0;
        updateSelection();
        clockPopup.classList.add("show");
        clockVisible = true;
      }
    }

    // Zeit √ºbernehmen aus Popup
    function applyTime() {
      let hour = parseInt(document.getElementById("hour-input").value);
      const minute = parseInt(document.getElementById("minute-input").value);
      if (useAMPM) {
        const amPm = document.getElementById("am-pm-select").value;
        if (amPm === "PM" && hour < 12) hour += 12;
        if (amPm === "AM" && hour === 12) hour = 0;
      }
      if (isNaN(hour) || hour < 0 || hour > 23) {
        alert("Ung√ºltige Stunde!");
        return;
      }
      if (![0,15,30,45].includes(minute)) {
        alert("Ung√ºltige Minute!");
        return;
      }
      // timerange Feld f√ºllen (nur Startzeit, keine Endzeit)
      // Format 08:15 oder 20:00
      const timerangeStr = `${hour.toString().padStart(2, "0")}:${minute.toString().padStart(2, "0")}`;
      document.getElementById("timerange").value = timerangeStr;
      toggleClockPopup();
    }

    // Admin Passwort erst beim L√∂schen abfragen
    async function deleteSession(id) {
      if (!isAdmin) {
        const enteredKey = prompt(translations[uiLang].adminPrompt);
        if (enteredKey === ADMIN_KEY) {
          isAdmin = true;
        } else {
          alert("Kein Zugriff!");
          return;
        }
      }
      if (confirm(translations[uiLang].deleteConfirm)) {
        await db.collection("entries").doc(id).delete();
        loadSessions();
      }
    }

    // Parse Zeitbereich (nur Startzeit oder Start-Ende mit HH:mm)
    function parseTimeRange(str) {
      const parts = str.toLowerCase().replace(/ /g, '').split('-');
      return parts.map(t => {
        let pm = t.includes('pm');
        let am = t.includes('am');
        t = t.replace(/am|pm/, '');
        const [h, m] = t.split(':').map(Number);
        let hour = h;
        let minute = m || 0;
        if (pm && hour < 12) hour += 12;
        if (am && hour === 12) hour = 0;
        return { h: hour, m: minute };
      });
    }

    // Zeit formatieren
    function formatTime({ h, m }) {
      return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
    }

    // Besucherzeit berechnen
    function convertToVisitorTime(hour, minute, userOffset) {
      const localOffset = new Date().getTimezoneOffset() / -60;
      let visitorHour = hour - userOffset + localOffset;
      if (visitorHour < 0) visitorHour += 24;
      if (visitorHour >= 24) visitorHour -= 24;
      return { h: Math.floor(visitorHour), m: minute };
    }

    // Sitzungen laden
    async function loadSessions() {
      const snapshot = await db.collection('entries').get();
      const listEl = document.getElementById("list");
      listEl.innerHTML = ''; // Liste leeren

      if (snapshot.empty) {
        listEl.innerHTML = translations[uiLang].emptyText || 'Keine Sitzungen gefunden.';
        return;
      }

      snapshot.forEach(doc => {
        const data = doc.data();
        const { name, game, timerange, tzoffset, date } = data;
        const [from] = parseTimeRange(timerange);
        const visitorFrom = convertToVisitorTime(from.h, from.m, tzoffset);

        let formattedDate = '';
        if (date) {
          formattedDate = new Date(date).toLocaleDateString(navigator.language);
        }

        const item = document.createElement('div');
        item.className = 'list-item';

        const deleteBtnHTML = `<button class="delete-btn" onclick="deleteSession('${doc.id}')">√ó</button>`;

        item.innerHTML = `
          <div>
            <strong>${name}</strong> ‚Äî ${game}<br>
            Datum: ${formattedDate}<br>
            Nutzerzeit: ${timerange} (UTC${tzoffset >= 0 ? '+' : ''}${tzoffset})<br>
            Lokale Zeit: <b>${formatTime(visitorFrom)}</b>
          </div>
          ${isAdmin ? deleteBtnHTML : ''}
        `;
        listEl.appendChild(item);
      });
    }

    // Sitzung hinzuf√ºgen
    async function addSession() {
      const name = document.getElementById('name').value.trim();
      const game = document.getElementById('game').value.trim();
      const timerange = document.getElementById('timerange').value.trim();
      const tzoffsetStr = document.getElementById('tzoffset').value.trim();
      const tzoffset = parseFloat(tzoffsetStr);

      if (!name || !game || !timerange || isNaN(tzoffset)) {
        alert(uiLang === "de" ? "Bitte alle Felder ausf√ºllen!" : uiLang === "es" ? "¬°Por favor, complete todos los campos!" : "Please fill all fields!");
        return;
      }

      await db.collection('entries').add({ name, game, timerange, tzoffset });
      document.getElementById('name').value = '';
      document.getElementById('game').value = '';
      document.getElementById('timerange').value = '';
      document.getElementById('tzoffset').value = '';
      loadSessions();
    }

    // Initial Sitzungen laden
    loadSessions();
  </script>
</body>
</html>
