<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aktuelle Sitzungen</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #e8f0ff, #f8fbff);
      color: #222;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      font-size: 2rem;
      margin-bottom: 10px;
    }
    .theme-toggle {
      display: block;
      margin: 0 auto 20px auto;
      padding: 10px 20px;
      background: #4a8bff;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: bold;
    }
    .card {
      background: #fff;
      padding: 24px;
      border-radius: 20px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
      max-width: 600px;
      margin: 20px auto;
    }
    .form-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .form-row input {
      flex: 1 1 120px;
      padding: 8px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 0.95rem;
    }
    .form-row button.submit {
      flex: 0 0 auto;
      padding: 8px 16px;
      font-weight: bold;
      background: #4a8bff;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    .list-item {
      max-width: 500px;
      padding: 10px;
      margin: 10px auto;
      border-radius: 12px;
      background: #f5f8ff;
      border: 1px solid #e2e8f0;
      transition: 0.25s;
      font-size: 0.95rem;
    }
    .list-item:hover {
      background: #e1efff;
      transform: translateY(-2px);
    }
    .item-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .delete-btn {
      background: #ff4a4a;
      color: white;
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      font-weight: bold;
      cursor: pointer;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .empty-text {
      text-align: center;
      padding: 20px;
      color: #777;
    }
    .dark {
      background: #1a1a1a;
      color: #eaeaea;
    }
    .dark .card { background: #262626; }
    .dark input { background: #262626; color: #eaeaea; border: 1px solid #444; }
    .dark .list-item { background: #333; border: 1px solid #444; }
  </style>
</head>
<body>
  <h1>Aktuelle Sitzungen</h1>
  <button class="theme-toggle" onclick="toggleTheme()">üåô / ‚òÄÔ∏è</button>

  <!-- Formular f√ºr neue Sitzung -->
  <div class="card">
    <h2>Neue Sitzung hinzuf√ºgen</h2>
    <div class="form-row">
      <input id="name" placeholder="Name (PSN)" />
      <input id="game" placeholder="Spiel" />
      <input id="timerange" placeholder="Zeitraum (z.B. 8-12)" />
    </div>
    <div class="form-row">
      <input id="date" placeholder="Datum ausw√§hlen" />
      <input id="tzoffset" placeholder="UTC-Offset" />
      <button class="submit" onclick="addSession()">Speichern</button>
    </div>
  </div>

  <!-- Verf√ºgbarkeitsliste -->
  <div class="card">
    <h2>Verf√ºgbarkeitsliste</h2>
    <div id="list">Wird geladen...</div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>
    // Admin-Schl√ºssel
    const ADMIN_KEY = "MEIN_GEHEIM_KEY";
    let isAdmin = false;

    // Admin-√úberpr√ºfung
    window.addEventListener('load', () => {
      const key = prompt("Admin-Schl√ºssel eingeben (nur wenn du l√∂schen willst):");
      if (key === ADMIN_KEY) {
        isAdmin = true;
      }
      loadSessions();  // Sitzungen nach Admin-Check laden
    });

    // Firebase-Konfiguration
    const firebaseConfig = {
      apiKey: "AIzaSyBu7TsiZAGJ7kQ8piqfrsyUFalEOM8eSGU",
      authDomain: "psn-planen.firebaseapp.com",
      projectId: "psn-planen",
      storageBucket: "psn-planen.firebasestorage.app",
      messagingSenderId: "1089591052960",
      appId: "1:1089591052960:web:069c515084f2105b22d7c5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const listEl = document.getElementById("list");

    // Dark Mode umschalten
    function toggleTheme() {
      document.body.classList.toggle('dark');
    }

    // Zeitbereich parsen
    function parseTimeRange(str) {
      const parts = str.toLowerCase().replace(/ /g, '').split('-');
      return parts.map(t => {
        let pm = t.includes('pm');
        let am = t.includes('am');
        t = t.replace(/am|pm/, '');
        const [h, m] = t.split(':').map(Number);
        let hour = h;
        let minute = m || 0;
        if (pm && hour < 12) hour += 12;
        if (am && hour === 12) hour = 0;
        return { h: hour, m: minute };
      });
    }

    // Zeit formatieren
    function formatTime({ h, m }) {
      return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
    }

    // Besucherzeit berechnen
    function convertToVisitorTime(hour, minute, userOffset) {
      const localOffset = new Date().getTimezoneOffset() / -60;
      let visitorHour = hour - userOffset + localOffset;
      if (visitorHour < 0) visitorHour += 24;
      if (visitorHour >= 24) visitorHour -= 24;
      return { h: Math.floor(visitorHour), m: minute };
    }

    // Sitzungen laden
    async function loadSessions() {
      const snapshot = await db.collection('entries').get();
      listEl.innerHTML = ''; // Liste leeren

      if (snapshot.empty) {
        listEl.innerHTML = 'Keine Sitzungen gefunden.';
        return;
      }

      snapshot.forEach(doc => {
        const data = doc.data();
        const { name, game, timerange, tzoffset, date } = data;
        const [from, to] = parseTimeRange(timerange);
        const visitorFrom = convertToVisitorTime(from.h, from.m, tzoffset);
        const visitorTo = convertToVisitorTime(to.h, to.m, tzoffset);

        let formattedDate = '';
        if (date) {
          formattedDate = new Date(date).toLocaleDateString(navigator.language);
        }

        const item = document.createElement('div');
        item.className = 'list-item';

        const deleteBtnHTML = isAdmin ? `<button class="delete-btn" onclick="deleteSession('${doc.id}')">X</button>` : '';

        item.innerHTML = `
          <div class="item-content">
            <div>
              <strong>${name}</strong> ‚Äî ${game}<br>
              Datum: ${formattedDate}<br>
              Nutzerzeit: ${timerange} (UTC${tzoffset >= 0 ? '+' : ''}${tzoffset})<br>
              Lokale Zeit: <b>${formatTime(visitorFrom)} - ${formatTime(visitorTo)}</b>
            </div>
            ${deleteBtnHTML}
          </div>
        `;
        listEl.appendChild(item);
      });
    }

    // Sitzung hinzuf√ºgen
    async function addSession() {
      const name = document.getElementById('name').value;
      const game = document.getElementById('game').value;
      const timerange = document.getElementById('timerange').value;
      const tzoffset = parseFloat(document.getElementById('tzoffset').value);

      if (!name || !game || !timerange || isNaN(tzoffset)) {
        alert('Bitte alle Felder ausf√ºllen!');
        return;
      }

      await db.collection('entries').add({ name, game, timerange, tzoffset });
      document.getElementById('name').value = '';
      document.getElementById('game').value = '';
      document.getElementById('timerange').value = '';
      document.getElementById('tzoffset').value = '';
      loadSessions();
    }

    // Sitzung l√∂schen
    async function deleteSession(id) {
      if (!isAdmin) {
        alert('Nur der Admin kann Sitzungen l√∂schen!');
        return;
      }
      await db.collection('entries').doc(id).delete();
      loadSessions();
    }
  </script>
</body>
</html>
