<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Sitzungsplaner — stabile Version</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<style>
:root {
  --bg: #f4f8ff;
  --card: #fff;
  --accent: #4a8bff;
  --muted: #6b7280;
  --text: #0f172a;
}
body {
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  margin: 0;
  background: var(--bg);
  color: var(--text);
}
.container { max-width: 900px; margin: 28px auto; padding: 20px; }
.header { display: flex; justify-content: space-between; align-items: center; }
.title { display: flex; gap: 12px; align-items: center; }
.title h1 { margin: 0; font-size: 20px; }
.card {
  background: var(--card);
  padding: 18px;
  border-radius: 14px;
  margin-top: 16px;
  box-shadow: 0 8px 30px rgba(16, 24, 40, .06);
}
.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 12px;
}
.input { padding: 10px; border-radius: 10px; border: 1px solid #e6eefc; }
.btn {
  background: var(--accent); color: #fff;
  padding: 10px 14px; border-radius: 10px; border: none; cursor: pointer;
}
.sessions { margin-top: 18px; display: flex; flex-direction: column; gap: 10px; }
.session {
  background: #fff;
  border: 1px solid #eef4ff;
  padding: 12px;
  border-radius: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.small { font-size: 13px; color: var(--muted); }
.delete { background: #ff4d4f; border: none; color: white; padding: 8px; border-radius: 8px; cursor: pointer; }
.toggle { background: #111; color: #fff; padding: 8px; border-radius: 8px; border: none; }

/* DARK MODE */
.dark {
  --bg: #0b1220;
  --card: #0f1724;
  --text: #e6eef8;
}
.dark body { color: var(--text); }
.dark h1, .dark h3, .dark strong, .dark .small { color: var(--text) !important; }
.dark .session {
  background: #131b2c !important;
  border-color: #1f2940 !important;
}
.dark .input { background: #1a2336; color: var(--text); border-color: #2d3a55; }
.dark .btn { background: #2f5cff; }
.dark .card { background: var(--card); }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="title">
      <svg width="28" height="28" viewBox="0 0 24 24"><path d="M7 11h5v5H7z" fill="#4a8bff"/><path d="M3 5h18v16H3z" stroke="#4a8bff" stroke-width="1.2" fill="none"/></svg>
      <h1>Sitzungsplaner — stabile Version</h1>
    </div>
    <div class="controls">
      <button id="themeBtn" class="toggle">Dark</button>
      <select id="langSelect" class="input" style="width:auto">
        <option value="auto">Auto</option>
        <option value="de">Deutsch</option>
        <option value="en">English</option>
      </select>
    </div>
  </div>

  <!-- FORM -->
  <div class="card">
    <form id="sessionForm" class="form-grid">
      <input id="name" class="input" placeholder="Name (PSN)">
      <input id="game" class="input" placeholder="Game / Kategorie">
      <input id="dateFrom" class="input" placeholder="Start-Datum">
      <input id="dateTo" class="input" placeholder="End-Datum">
      <input id="timeFrom" class="input" placeholder="Startzeit (18:30 oder 6:30 PM)">
      <input id="timeTo" class="input" placeholder="Endzeit">
      <input id="tzoffset" class="input" placeholder="UTC Offset z.B. +1">
      <button id="saveBtn" type="button" class="btn">Save session</button>
    </form>
  </div>

  <!-- SESSION LIST -->
  <div class="card">
    <h3>Sessions</h3>
    <div id="sessions" class="sessions"></div>
  </div>

  <!-- KATEGORIE B2 -->
  <div class="card">
    <h3>Kategorie B2</h3>
    <div id="b2list" class="sessions"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBu7TsiZAGJ7kQ8piqfrsyUFalEOM8eSGU",
  authDomain: "psn-planen.firebaseapp.com",
  projectId: "psn-planen",
  storageBucket: "psn-planen.firebasestorage.app",
  messagingSenderId: "1089591052960",
  appId: "1:1089591052960:web:069c515084f2105b22d7c5"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const colRef = collection(db, "sessions");

const browserLang = navigator.language || "de";
const autoOffset = -new Date().getTimezoneOffset() / 60;
function formatOffset(v){ const n = Number(v); return (n>=0?"+":"") + n; }
document.getElementById("tzoffset").value = formatOffset(autoOffset);

await import("https://cdn.jsdelivr.net/npm/flatpickr");

function getLocale(){
  const sel = document.getElementById("langSelect").value;
  return sel === "auto" ? browserLang : sel;
}

function initCalendar() {
  const locale = getLocale();
  flatpickr(dateFrom, { altInput:true, altFormat: locale.startsWith("de") ? "d.m.Y" : "F j, Y", dateFormat:"Y-m-d", allowInput:true });
  flatpickr(dateTo,   { altInput:true, altFormat: locale.startsWith("de") ? "d.m.Y" : "F j, Y", dateFormat:"Y-m-d", allowInput:true });
}
initCalendar();
langSelect.addEventListener("change", initCalendar);

themeBtn.addEventListener("click", ()=>{
  document.documentElement.classList.toggle("dark");
  themeBtn.textContent = document.documentElement.classList.contains("dark") ? "Light" : "Dark";
});

function convertToLocalTime(t, tz){
  if (!t || t.trim()==="") return "";
  t = t.trim().toLowerCase().replace(/\s+/g,"");
  let h=0,m=0;
  const isPM = t.includes("pm");
  const isAM = t.includes("am");
  t = t.replace(/am|pm/,"");

  if(t.includes(":")){
    const parts = t.split(":");
    h = parseInt(parts[0],10)||0;
    m = parseInt(parts[1],10)||0;
  } else if(t.length <= 2){
    h = parseInt(t,10)||0; m=0;
  } else if(t.length === 3){
    h = parseInt(t[0],10)||0; m=parseInt(t.slice(1),10)||0;
  } else if(t.length ===4){
    h = parseInt(t.slice(0,2),10)||0; m=parseInt(t.slice(2),10)||0;
  }

  if(isPM && h<12) h+=12;
  if(isAM && h===12) h=0;

  const d=new Date();
  d.setHours(h - parseFloat(tz) + autoOffset, m, 0,0);
  return d.toLocaleTimeString(getLocale(),{hour:"2-digit",minute:"2-digit"});
}

async function loadSessions(){
  const list = document.getElementById("sessions");
  const b2 = document.getElementById("b2list");
  list.innerHTML = ""; b2.innerHTML="";

  const snap = await getDocs(colRef);
  if(snap.empty){ list.innerHTML="<div class='small'>Keine Sessions</div>"; return; }

  const groups={};
  snap.forEach(d=>{
    const data=d.data();
    if(!groups[data.game]) groups[data.game]=[];
    groups[data.game].push({id:d.id,data});
  });

  Object.keys(groups).sort().forEach(game=>{
    const header = document.createElement("div");
    header.className="session";
    header.innerHTML=`<strong>${game}</strong>`;
    list.appendChild(header);

    groups[game].forEach(entry=>{
      const d = entry.data;
      const date1 = d.dateFrom ? new Date(d.dateFrom).toLocaleDateString(getLocale(),{weekday:"short",year:"numeric",month:"2-digit",day:"2-digit"}):"";
      const date2 = d.dateTo   ? new Date(d.dateTo).toLocaleDateString(getLocale(),{weekday:"short",year:"numeric",month:"2-digit",day:"2-digit"}):"";
      const t1 = convertToLocalTime(d.timeFrom,d.tzoffset);
      const t2 = convertToLocalTime(d.timeTo,d.tzoffset);

      const row = document.createElement("div");
      row.className="session"; row.style.marginLeft="18px";
      row.innerHTML=`
        <div>
          <strong>${d.name}</strong><br>
          <span class="small">${date1} → ${date2}<br>${t1} – ${t2} (UTC${formatOffset(d.tzoffset)})</span>
        </div>
        <button class="delete">X</button>
      `;
      row.querySelector(".delete").onclick = async()=>{
        await deleteDoc(doc(db,"sessions",entry.id));
        loadSessions();
      };

      list.appendChild(row);

      if(game.toLowerCase()==="b2" || game.toLowerCase()==="kategorie b2"){
        const b2row = row.cloneNode(true);
        b2.appendChild(b2row);
      }
    });
  });
}
loadSessions();

saveBtn.addEventListener("click",async()=>{
  const d={
    name: name.value.trim(),
    game: game.value.trim(),
    dateFrom: dateFrom.value,
    dateTo: dateTo.value,
    timeFrom: timeFrom.value.trim(),
    timeTo: timeTo.value.trim(),
    tzoffset: tzoffset.value.trim()
  };
  if(!d.name||!d.game||!d.dateFrom||!d.dateTo||!d.timeFrom||!d.timeTo||!d.tzoffset){return alert("Bitte alles ausfüllen!");}
  await addDoc(colRef,d);
  sessionForm.reset();
  tzoffset.value=formatOffset(autoOffset);
  loadSessions();
});
</script>

</body>
</html>
