<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PSN Sessionsplaner ‚Äî World Sync Pro</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/de.js"></script>

<style>
:root{
  --bg:#f4f8ff; 
  --card:#ffffff; 
  --text:#000000; 
  --accent:#4a8bff; 
  --border:#e5e7eb;
  --ps-blue: #dbeafe; 
}
body{ font-family:"Inter", sans-serif; background:var(--bg); margin:0; padding:16px; color:var(--text); font-size: 14px; }

.sticky-top-area {
  position: fixed; top: 0; left: 50%; transform: translateX(-50%);
  width: 100%; max-width: 880px; padding: 16px 16px 0 16px;
  background: var(--bg); z-index: 1000; box-sizing: border-box;
}
.container { max-width:880px; margin:0 auto; padding-top: 230px; }

.header{ display:flex; align-items:center; justify-content: space-between; padding:10px 16px; background:var(--card); border-radius:14px; margin-bottom:12px; box-shadow:0 4px 16px rgba(0,0,0,.08); }
.title{ font-size:22px; font-weight:600; display:flex; align-items:center; gap:10px; color: #000000; }
.title img{ width:28px; height:28px; }

.header-controls { display: flex; gap: 8px; align-items: center; }
#langSelect, #themeBtn{ padding:6px 10px; border-radius:8px; border:1px solid var(--border); background:var(--card); color: #000000; cursor:pointer; height: 36px;}

.card-form { background:var(--card); border-radius:14px; padding:16px; margin-bottom:16px; box-shadow:0 6px 20px rgba(0,0,0,.06); }

.form-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px; align-items: center; }
#name, #game { grid-column: span 6; }
.flatpickr-wrapper { grid-column: span 9; } 
#saveBtn { grid-column: span 3 !important; }

#saveBtn { 
  background: var(--accent); color: #fff; border: none; border-radius: 10px; 
  height: 40px; display: flex; align-items: center; justify-content: center;
  transition: transform 0.1s; cursor: pointer; font-weight: 600;
}
#saveBtn:active { transform: scale(0.95); }

.input{ padding:10px; border-radius:10px; border:1px solid var(--border); width: 100%; box-sizing: border-box; min-height: 40px; background: var(--card); color: #000000; outline: none; }

.game-box{ 
  background: var(--ps-blue); 
  border-radius:14px; 
  padding:12px; 
  margin-bottom:20px; 
  border: 1px solid #bfdbfe; 
}
.game-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding: 2px 8px; font-size: 18px; color: #000000; font-weight: 600; }

.delete-all { background:#ef4444; color:#fff; border:none; border-radius:8px; width:32px; height:32px; display:flex; align-items:center; justify-content:center; cursor:pointer; }

.session-group { 
  display: grid; 
  grid-template-columns: repeat(auto-fill, 180px); 
  gap: 10px; 
  padding: 12px 60px 12px 12px; 
  background: #ffffff; 
  border-radius: 12px; 
  border: 1px solid #e2e8f0; 
  position: relative;
  margin-bottom: 10px; 
}

.group-actions {
  position: absolute; 
  right: 12px; 
  top: 12px; bottom: 12px;
  display: flex; 
  flex-direction: column; 
  justify-content: center; 
  align-items: center; 
  gap: 8px;
}

.count-badge { background:#4a8bff; color:#fff; padding:4px 8px; border-radius:30px; font-size:11px; font-weight:bold; }

.session-item { 
  background: var(--ps-blue); 
  color: #000000; 
  border-radius: 10px; 
  padding: 10px 35px 10px 10px; 
  border: 1px solid #bfdbfe; 
  position: relative; 
  min-height: 80px; 
  width: 180px; 
  display: flex; 
  flex-direction: column; 
  justify-content: center; 
  box-sizing: border-box; 
}

.player-name{ font-weight:600; font-size:14px; margin-bottom: 2px; color: #000000; }
.date, .time{ font-size:13px; color: #000000; font-weight: 500; }
.time { white-space: nowrap; } /* Verhindert Zeilenumbruch bei der Uhrzeit */

.delete, .delete-day{ background:#ef4444; color:#fff; border:none; display:flex; align-items:center; justify-content:center; cursor:pointer; }
.delete { position:absolute; right:6px; top:50%; transform: translateY(-50%); width:20px; height:20px; border-radius:50%; font-size:11px; }
.delete-day{ width:28px; height:28px; border-radius:50%; background:#dc2626; font-size: 18px; }

/* DARKMODE */
.dark{ --bg:#0b1220; --card:#1e293b; --text:#ffffff; --border:#334155; }
.dark .sticky-top-area { background: #0b1220; }
.dark .game-box{ background:#161f2e !important; border: 1px solid #334155 !important; }
.dark .game-title { color: #ffffff; }
.dark .session-group{ background:#0f172a; border-color: #1e293b; }
.dark .input { background: linear-gradient(180deg, #334155, #1e293b) !important; color: #ffffff !important; border-color: #475569 !important; }
.dark .session-item { background: #1e293b; border-color:#475569; color: #ffffff; }
.dark .player-name { color: #1e90ff; } 
.dark .date, .dark .time, .dark .title, .dark #langSelect { color: #ffffff; }

.dark .input::placeholder { color: #ffffff; opacity: 1; }
.dark .input::-webkit-input-placeholder { color: #ffffff; }
.dark .input::-moz-placeholder { color: #ffffff; opacity: 1; }
.dark .input:-ms-input-placeholder { color: #ffffff; }

</style>
</head>
<body>

<div class="sticky-top-area">
  <div class="header">
    <div class="title" id="titleEl"><img src="https://www.clipartmax.com/png/small/120-1209857_free-psn-code-generator-logo-playstation-network.png"> PSN Planer</div>
    <div class="header-controls">
      <select id="langSelect"><option value="de">Deutsch</option><option value="en">English</option></select>
      <button id="themeBtn">‚òÄÔ∏è</button>
    </div>
  </div>
  <div class="card-form">
    <form class="form-grid" onsubmit="return false;">
      <input id="name" class="input">
      <input id="game" class="input">
      <div class="flatpickr-wrapper" id="fp-container"></div>
      <button id="saveBtn">üíæ</button>
    </form>
  </div>
</div>

<div class="container">
  <div id="sessions"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = { apiKey: "AIzaSyBu7TsiZAGJ7kQ8piqfrsyUFalEOM8eSGU", authDomain: "psn-planen.firebaseapp.com", projectId: "psn-planen" };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const colRef = collection(db, "sessions");

let fp;

function initFlatpickr(lang = 'de') {
  const isDe = lang === 'de';
  document.getElementById("name").placeholder = isDe ? "Name" : "Name";
  document.getElementById("game").placeholder = isDe ? "Spiel" : "Game";
  
  const container = document.getElementById('fp-container');
  const ph = isDe ? "Datum & Zeit" : "Date & Time";
  container.innerHTML = `<input id="dateRange" class="input" placeholder="${ph}">`;
  
  fp = flatpickr("#dateRange", { 
    locale: isDe ? flatpickr.l10ns.de : "default", 
    enableTime: true, 
    time_24hr: isDe,
    mode: "range", 
    altInput: true, 
    altFormat: isDe ? "d.m.Y H:i" : "m/d/Y h:i K"
  });
}

const userLang = navigator.language.startsWith("en") ? "en" : "de";
const langSelect = document.getElementById("langSelect");
const themeBtn = document.getElementById("themeBtn");
const saveBtn = document.getElementById("saveBtn");

langSelect.value = userLang;
initFlatpickr(userLang);

themeBtn.onclick = () => {
  document.documentElement.classList.toggle("dark");
  themeBtn.textContent = document.documentElement.classList.contains("dark") ? "üåô" : "‚òÄÔ∏è";
};

langSelect.onchange = () => { initFlatpickr(langSelect.value); renderSessions(); };

async function renderSessions() {
  const sessionsDiv = document.getElementById("sessions");
  const lang = langSelect.value;
  const isDe = lang === "de";
  sessionsDiv.innerHTML = `<p style="text-align:center;">${isDe ? "Lade..." : "Loading..."}</p>`;
  
  try {
    const snap = await getDocs(colRef);
    if (snap.empty) { sessionsDiv.innerHTML = ""; return; }
    
    const data = snap.docs.map(d => {
      const s = d.data();
      let displayTime, displayDate, sortKey, dateKey;

      if (s.startUTC) {
        const localStart = new Date(s.startUTC);
        const localEnd = new Date(s.endUTC);
        dateKey = localStart.toISOString().slice(0,10);
        displayDate = localStart.toLocaleDateString(isDe ? "de-DE" : "en-US");
        
        // Zeit generieren
        displayTime = localStart.toLocaleTimeString(isDe ? 'de-DE' : 'en-US', { hour:'2-digit',minute:'2-digit', hour12:!isDe }) 
                    + " ‚Äì " + localEnd.toLocaleTimeString(isDe ? 'de-DE' : 'en-US', { hour:'2-digit',minute:'2-digit', hour12:!isDe });
        
        // Optimierung f√ºr Englisch: " AM" zu "am", " PM" zu "pm" und Leerzeichen weg
        if (!isDe) {
          displayTime = displayTime.replace(/\sAM/g, 'am').replace(/\sPM/g, 'pm');
        }

        sortKey = localStart.getTime();
      } else {
        dateKey = "---";
        displayDate = s.date || "---";
        displayTime = `${s.from} ‚Äì ${s.to}`;
        sortKey = 0;
      }
      return { ...s, id: d.id, displayDate, displayTime, sortKey, dateKey };
    });

    const grouped = {};
    data.forEach(s => {
      if (!grouped[s.game]) grouped[s.game] = {};
      if (!grouped[s.game][s.dateKey]) grouped[s.game][s.dateKey] = [];
      grouped[s.game][s.dateKey].push(s);
    });

    sessionsDiv.innerHTML = "";
    Object.keys(grouped).sort().forEach(gameName => {
      const box = document.createElement("div");
      box.className = "game-box";
      box.innerHTML = `<div class="game-title"><b>${gameName}</b><button class="delete-all">üóëÔ∏è</button></div>`;
      
      box.querySelector(".delete-all").onclick = async () => {
        if (prompt("Admin-Key:") !== "Grandia2025") return;
        const q = query(colRef, where("game", "==", gameName));
        const qs = await getDocs(q);
        for (const d of qs.docs) await deleteDoc(doc(db, "sessions", d.id));
        renderSessions();
      };

      Object.keys(grouped[gameName]).sort().forEach(dateKey => {
        const groupDiv = document.createElement("div");
        groupDiv.className = "session-group";
        
        const actionsDiv = document.createElement("div");
        actionsDiv.className = "group-actions";
        actionsDiv.innerHTML = `<span class="count-badge">üë• ${grouped[gameName][dateKey].length}</span>`;
        
        const delDay = document.createElement("button");
        delDay.className = "delete-day";
        delDay.textContent = "√ó";
        delDay.onclick = async () => {
          if (prompt("Admin-Key:") !== "Grandia2025") return;
          for (const s of grouped[gameName][dateKey]) await deleteDoc(doc(db, "sessions", s.id));
          renderSessions();
        };
        actionsDiv.appendChild(delDay);
        groupDiv.appendChild(actionsDiv);

        grouped[gameName][dateKey]
          .sort((a, b) => a.sortKey - b.sortKey)
          .forEach(s => {
            const item = document.createElement("div");
            item.className = "session-item";
            item.innerHTML = `<div>üéÆ <b class="player-name">${s.name}</b></div><div class="date">üìÖ ${s.displayDate}</div><div class="time">‚è∞ ${s.displayTime}</div>`;
            const delBtn = document.createElement("button"); delBtn.className = "delete"; delBtn.textContent = "√ó";
            delBtn.onclick = async () => {
              if (prompt("Admin-Key:") !== "Grandia2025") return;
              await deleteDoc(doc(db, "sessions", s.id));
              renderSessions();
            };
            item.appendChild(delBtn);
            groupDiv.appendChild(item);
        });
        box.appendChild(groupDiv);
      });
      sessionsDiv.appendChild(box);
    });
  } catch (e) { console.error(e); }
}

saveBtn.onclick = async () => {
  if (fp.selectedDates.length !== 2) return;
  const [start, end] = fp.selectedDates;
  const nameVal = document.getElementById("name").value.trim();
  const gameVal = document.getElementById("game").value.trim();
  if (!nameVal || !gameVal) return;

  let cur = new Date(start);
  while (cur <= end) {
    const sUTC = new Date(cur);
    const eUTC = new Date(cur);
    eUTC.setHours(end.getHours(), end.getMinutes());
    await addDoc(colRef, { name: nameVal, game: gameVal, startUTC: sUTC.toISOString(), endUTC: eUTC.toISOString() });
    cur.setDate(cur.getDate() + 1);
    if(start.toLocaleDateString() === end.toLocaleDateString()) break;
  }
  document.getElementById("name").value = ""; 
  document.getElementById("game").value = ""; 
  fp.clear(); 
  renderSessions();
};
renderSessions();
</script>
</body>
</html>
