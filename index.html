<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aktuelle Sitzungen</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet"/>

  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css" />
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- Analog Clock Plugin -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/analogClock/analogClock.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/analogClock/analogClock.css">

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #e8f0ff, #f8fbff);
      color: #222;
      margin: 0;
      padding: 20px;
    }
    h1 { text-align: center; margin-bottom: 10px; }

    .theme-toggle {
      display: block;
      margin: 0 auto 20px;
      padding: 10px 20px;
      background: #4a8bff;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: bold;
    }
    .card {
      background: #fff;
      padding: 24px;
      border-radius: 20px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
      max-width: 650px;
      margin: 20px auto;
    }

    /* Responsive Form */
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    .form-row input,
    .form-row button {
      flex: 1 1 calc(50% - 12px);
      min-width: 140px;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid #ccc;
    }
    @media (max-width: 600px) {
      .form-row input, .form-row button { flex: 1 1 100%; }
    }

    .list-item {
      max-width: 500px;
      padding: 10px;
      margin: 10px auto;
      border-radius: 12px;
      background: #f5f8ff;
      border: 1px solid #e2e8f0;
      transition: .25s;
    }
    .list-item:hover {
      background: #e1efff;
      transform: translateY(-2px);
    }

    .item-content { display: flex; justify-content: space-between; }

    .delete-btn {
      background: #ff4a4a;
      color: white;
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      cursor: pointer;
    }

    /* WINDOWS 11 ACRYLIC & ANIMATION ---------------------------------- */
    .flatpickr-calendar,
    .analog-clock-container {
      backdrop-filter: blur(20px) saturate(170%);
      -webkit-backdrop-filter: blur(20px) saturate(170%);
      background: rgba(255,255,255,0.55) !important;
      border-radius: 26px !important;
      border: 1px solid rgba(255,255,255,0.30) !important;
      box-shadow: 0 12px 48px rgba(0,0,0,0.18);
      opacity: 0;
      transform: scale(0.85);
      transform-origin: top center;
      transition:
        opacity .22s ease,
        transform .25s cubic-bezier(0.16, 0.84, 0.44, 1),
        box-shadow .25s ease;
    }
    .flatpickr-calendar.open,
    .analog-clock-container.open {
      opacity: 1 !important;
      transform: scale(1) !important;
      box-shadow: 0 18px 55px rgba(90,150,255,0.35);
    }
    .flatpickr-calendar.closing,
    .analog-clock-container.closing {
      opacity: 0 !important;
      transform: scale(0.9) !important;
      box-shadow: 0 4px 15px rgba(0,0,0,0.10);
    }

    /* Dark mode */
    .dark {
      background: #121212;
      color: #eee;
    }
    .dark .card { background: #1f1f1f; }
    .dark input { background: #222; border-color: #555; }
    .dark .list-item { background: #222; }
    .dark .flatpickr-calendar,
    .dark .analog-clock-container {
      background: rgba(30,30,30,0.55) !important;
      border: 1px solid rgba(255,255,255,0.18) !important;
      box-shadow: 0 12px 48px rgba(0,0,0,0.55);
    }
  </style>
</head>
<body>

  <h1>Aktuelle Sitzungen</h1>
  <button class="theme-toggle" onclick="toggleTheme()">üåô / ‚òÄÔ∏è</button>

  <!-- Formular -->
  <div class="card">
    <h2>Neue Sitzung hinzuf√ºgen</h2>
    <div class="form-row">
      <input id="name" placeholder="Name (PSN)">
      <input id="game" placeholder="Spiel">
      <input id="date" placeholder="Datum w√§hlen">
    </div>

    <div class="form-row">
      <input id="time_from" class="timepick" placeholder="Startzeit">
      <input id="time_to" class="timepick" placeholder="Endzeit">
      <input id="tzoffset" placeholder="UTC-Offset">
      <button class="submit" onclick="addSession()">Speichern</button>
    </div>
  </div>

  <!-- Liste -->
  <div class="card">
    <h2>Verf√ºgbarkeitsliste</h2>
    <div id="list">Wird geladen...</div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>
    /* ADMIN KEY */
    const ADMIN_KEY = "MEIN_GEHEIM_KEY";
    let isAdmin = false;

    window.addEventListener("load", () => {
      const key = prompt("Admin-Schl√ºssel eingeben (nur wenn du l√∂schen willst):");
      if (key === ADMIN_KEY) isAdmin = true;
      loadSessions();
    });

    /* FIREBASE */
    const firebaseConfig = {
      apiKey: "AIzaSyBu7TsiZAGJ7kQ8piqfrsyUFalEOM8eSGU",
      authDomain: "psn-planen.firebaseapp.com",
      projectId: "psn-planen",
      storageBucket: "psn-planen.firebasestorage.app",
      messagingSenderId: "1089591052960",
      appId: "1:1089591052960:web:069c515084f2105b22d7c5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function toggleTheme() {
      document.body.classList.toggle("dark");
    }

    /* Locale Detection */
    const lang = navigator.language || "en-US";
    const short = lang.split("-")[0];
    const use12h = ["en","ca","au","nz"].includes(short);

    /* FLATPICKR SETUP */
    document.addEventListener("DOMContentLoaded", () => {

      flatpickr("#date", {
        altInput: true,
        dateFormat: "Y-m-d",
        altFormat: short === "de" ? "d.m.Y" : "F j, Y",
        locale: lang,
        allowInput: true
      });

      document.querySelectorAll(".timepick").forEach(el => {
        flatpickr(el, {
          enableTime: true,
          noCalendar: true,
          dateFormat: use12h ? "h:i K" : "H:i",
          time_24hr: !use12h,
          locale: lang,
          plugins: [
            new analogClock({
              hourFormat: use12h ? 12 : 24,
              theme: "light",
              handColors: { hour:"#4a8bff", minute:"#4a8bff" }
            })
          ]
        });
      });

      /* Enable Animated Opening */
      setTimeout(() => {
        enablePopupAnimations("#date, .timepick");
      }, 300);
    });

    function enablePopupAnimations(selector) {
      document.querySelectorAll(selector).forEach(el => {
        el._flatpickr.config.onOpen.push(function() {
          const popup = this.calendarContainer || document.querySelector(".analog-clock-container");
          if (!popup) return;
          popup.classList.remove("closing");
          requestAnimationFrame(() => popup.classList.add("open"));
        });

        el._flatpickr.config.onClose.push(function() {
          const popup = this.calendarContainer || document.querySelector(".analog-clock-container");
          if (!popup) return;
          popup.classList.remove("open");
          popup.classList.add("closing");

          setTimeout(() => popup.classList.remove("closing"), 220);
        });
      });
    }

    /* Sessions */
    async function loadSessions() {
      const snapshot = await db.collection("entries").get();
      const listEl = document.getElementById("list");
      listEl.innerHTML = "";

      if (snapshot.empty) return (listEl.innerHTML = "Keine Sitzungen gefunden.");

      snapshot.forEach(doc => {
        const d = doc.data();
        const item = document.createElement("div");
        item.className = "list-item";

        const del = isAdmin
          ? `<button class="delete-btn" onclick="deleteSession('${doc.id}')">X</button>`
          : "";

        item.innerHTML = `
          <div class="item-content">
            <div>
              <strong>${d.name}</strong> ‚Äî ${d.game}<br>
              Datum: ${new Date(d.date).toLocaleDateString(lang)}<br>
              Nutzerzeit: ${d.timerange} (UTC${d.tzoffset >= 0 ? "+" : ""}${d.tzoffset})
            </div>
            ${del}
          </div>
        `;
        listEl.appendChild(item);
      });
    }

    async function addSession() {
      const name = name.value;
      const game = game.value;
      const dateV = date.value;
      const t1 = time_from.value;
      const t2 = time_to.value;
      const tz = parseFloat(tzoffset.value);

      if (!name || !game || !dateV || !t1 || !t2 || isNaN(tz)) {
        return alert("Bitte alles ausf√ºllen!");
      }

      const timerange = `${t1}-${t2}`;

      await db.collection("entries").add({ name, game, date: dateV, timerange, tzoffset: tz });
      loadSessions();
    }

    async function deleteSession(id) {
      if (!isAdmin) return alert("Nur Admin!");
      await db.collection("entries").doc(id).delete();
      loadSessions();
    }
  </script>
</body>
</html>
