<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PSN Sessionsplaner</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/de.js"></script>

<style>
:root {
  --bg:#f4f8ff;
  --card:#fff;
  --accent:#4a8bff;
  --muted:#6b7280;
}
body { font-family:Inter,sans-serif; background:var(--bg); margin:0; color:#0f172a; }
.container { max-width:900px; margin:30px auto; padding:20px; }
.header { display:flex; justify-content:flex-end; align-items:center; gap:8px; margin-bottom:16px; }
.title { flex-grow:1; display:flex; align-items:center; font-weight:600; font-size:20px; }
.card { background:var(--card); padding:18px; border-radius:14px; box-shadow:0 8px 30px rgba(0,0,0,.06); margin-bottom:16px; }
.form-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:12px; }
.input { padding:10px; border-radius:10px; border:1px solid #e5e7eb; }
.btn { background:var(--accent); color:#fff; border:none; border-radius:10px; padding:10px; cursor:pointer; }
.sessions { display:flex; flex-direction:column; gap:12px; }
.game-box { background:#eef4ff; border-radius:12px; padding:10px; }
.game-title { font-weight:600; display:flex; justify-content:space-between; margin-bottom:6px; }
.session { padding:6px 8px; border-radius:8px; background:#fff; border:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; font-size:14px; }
.small { font-size:12px; color:var(--muted); }
.delete { background:#ef4444; color:#fff; border:none; width:26px; height:26px; border-radius:50%; cursor:pointer; font-size:16px; }
#langSelect, #themeBtn { width:auto; padding:6px 10px; border-radius:8px; border:1px solid #e5e7eb; cursor:pointer; font-size:14px; }

/* Darkmode */
.dark {
  --bg:#0b1220;
  --card:#0f1724;
  --accent:#4a8bff;
  --muted:#e6eef8;
  color: var(--muted);
}
.dark .card { background: var(--card); color: var(--muted); }
.dark .game-box { background: #1e293b; color: var(--muted); }
.dark .session { background:#2d3748; border:1px solid #2b6cb0; color:#e5e7eb; }
.dark .small { color: #cbd5e0; }
.card h3 { color:#0f172a; margin-bottom:8px; }
.dark h3 { color:#fff; }

/* Titel im Darkmode */
.dark .title h1 {
  color: #ffffff; /* Wei√ü f√ºr den Titel im Darkmode */
}
</style>
</head>

<body>
<div class="container">

  <div class="header">
    <div class="title">
      <h1 id="titleEl">
        <img src="https://static.wikia.nocookie.net/esfinalfantasy/images/2/2d/PSN.jpg/revision/latest?cb=20100509141922" 
             style="width:24px; height:24px; vertical-align:middle; margin-right:8px;">
        PSN Sessionsplaner
      </h1>
    </div>
    <select id="langSelect">
      <option value="de" selected>Deutsch</option>
      <option value="en">English</option>
    </select>
    <button id="themeBtn">‚òÄÔ∏è</button>
  </div>

  <div class="card">
    <form id="sessionForm" class="form-grid">
      <input id="name" class="input" placeholder="Name">
      <input id="game" class="input" placeholder="Spiel">
      <input id="dateRange" class="input" placeholder="Datum & Uhrzeit">
      <input id="tzoffset" class="input" placeholder="UTC Offset (z.B. +1)">
      <button id="saveBtn" class="btn" type="button">Session speichern</button>
    </form>
  </div>

  <div class="card">
    <h3>Sessions</h3>
    <div id="sessions" class="sessions"></div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBu7TsiZAGJ7kQ8piqfrsyUFalEOM8eSGU",
  authDomain: "psn-planen.firebaseapp.com",
  projectId: "psn-planen"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const colRef = collection(db, "sessions");

const tzInput = document.getElementById("tzoffset");
const dateInput = document.getElementById("dateRange");
const langSelect = document.getElementById("langSelect");
const nameInput = document.getElementById("name");
const gameInput = document.getElementById("game");
const saveBtn = document.getElementById("saveBtn");
const sessionsEl = document.getElementById("sessions");
const themeBtn = document.getElementById("themeBtn");
const titleEl = document.getElementById("titleEl");

// Automatischer UTC Offset
const autoOffset = -new Date().getTimezoneOffset() / 60;
tzInput.value = (autoOffset>=0?"+":"")+autoOffset;

// Flatpickr initial
let fp = flatpickr(dateInput, {
  locale: flatpickr.l10ns.de,
  enableTime: true,
  time_24hr: true,
  dateFormat: "Y-m-d H:i",
  altInput: true,
  altFormat: "d.m.Y H:i",
  mode: "range",
  weekStart: 1
});

// Sprache wechseln
langSelect.addEventListener("change", () => {
  if(langSelect.value === "de") {
    fp.set("locale", flatpickr.l10ns.de);
    fp.set("altFormat", "d.m.Y H:i");
    fp.set("weekStart", 1);
    dateInput.placeholder = "Datum & Uhrzeit";
    fp.altInput.placeholder = "Datum & Uhrzeit";
    nameInput.placeholder = "Name";
    gameInput.placeholder = "Spiel";
    tzInput.placeholder = "UTC Offset (z.B. +1)";
    saveBtn.textContent = "Session speichern";
    titleEl.innerHTML = '<img src="https://static.wikia.nocookie.net/esfinalfantasy/images/2/2d/PSN.jpg/revision/latest?cb=20100509141922" style="width:24px; height:24px; vertical-align:middle; margin-right:8px;"> PSN-Sessionsplaner';
  } else {
    fp.set("locale", undefined);
    fp.set("altFormat", "m/d/Y H:i");
    fp.set("weekStart", 0);
    dateInput.placeholder = "Date & Time";
    fp.altInput.placeholder = "Date & Time";
    nameInput.placeholder = "Name";
    gameInput.placeholder = "Game";
    tzInput.placeholder = "UTC Offset (e.g. +1)";
    saveBtn.textContent = "Save Session";
    titleEl.innerHTML = '<img src="https://static.wikia.nocookie.net/esfinalfantasy/images/2/2d/PSN.jpg/revision/latest?cb=20100509141922" style="width:24px; height:24px; vertical-align:middle; margin-right:8px;"> Session Planner';
  }
});

// Darkmode
themeBtn.addEventListener("click", ()=>{
  document.documentElement.classList.toggle("dark");
  themeBtn.textContent = document.documentElement.classList.contains("dark")?"üåô":"‚òÄÔ∏è";
});

// Formatierungen
function toUTC(date){ return date.toISOString(); }
function formatTimeRange(fromISO,toISO){
  const from=new Date(fromISO);
  const to=new Date(toISO);
  return `${from.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"})} ‚Äì ${to.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"})}`;
}
function formatDateRange(fromISO,toISO){
  const from=new Date(fromISO);
  const to=new Date(toISO);
  const sameDay = from.getFullYear()===to.getFullYear() && from.getMonth()===to.getMonth() && from.getDate()===to.getDate();
  return sameDay ? from.toLocaleDateString() : `${from.toLocaleDateString()} ‚Äì ${to.toLocaleDateString()}`;
}
function groupByGame(sessions){
  const map={};
  sessions.forEach(s=>{ if(!map[s.game]) map[s.game]=[]; map[s.game].push(s); });
  return map;
}

// Sessions anzeigen
async function renderSessions(){
  sessionsEl.innerHTML="";
  const snap=await getDocs(colRef);
  if(snap.empty){ sessionsEl.innerHTML="<div class='small'>Keine Sessions</div>"; return; }

  const sessions=snap.docs.map(d=>({...d.data(),id:d.id})).sort((a,b)=>new Date(a.from)-new Date(b.from));
  const grouped=groupByGame(sessions);

  for(const [game,list] of Object.entries(grouped)){
    const box=document.createElement("div");
    box.className="game-box";
    const title=document.createElement("div");
    title.className="game-title";
    title.innerHTML=`<span>${game}</span><span>üë• ${list.length}</span>`;
    box.appendChild(title);

    list.forEach(s=>{
      const el=document.createElement("div");
      el.className="session";
      el.innerHTML=`
        <div>
          <div style="font-weight:600">üéÆ${s.name}</div>
          <div class="small">üìÖ ${formatDateRange(s.from,s.to)}</div>
          <div class="small">‚è∞ ${formatTimeRange(s.from,s.to)}</div>
        </div>
      `;
      const del=document.createElement("button");
      del.className="delete";
      del.textContent="√ó";
      del.onclick=async()=>{if(prompt("Admin-Key")!=="Grandia2025")return;await deleteDoc(doc(db,"sessions",s.id));renderSessions();}
      el.appendChild(del);
      box.appendChild(el);
    });

    sessionsEl.appendChild(box);
  }
}

// Session speichern
saveBtn.onclick=async()=>{
  if(fp.selectedDates.length!==2) return alert(langSelect.value==="de"?"Start & Ende ausw√§hlen":"Select start & end");
  const data={
    name:nameInput.value.trim(),
    game:gameInput.value.trim(),
    from:toUTC(fp.selectedDates[0]),
    to:toUTC(fp.selectedDates[1]),
    tz:tzInput.value
  };
  if(!data.name||!data.game) return alert(langSelect.value==="de"?"Alle Felder ausf√ºllen":"Fill all fields");
  await addDoc(colRef,data);
  document.getElementById("sessionForm").reset();
  tzInput.value = (autoOffset>=0?"+":"")+autoOffset;
  renderSessions();
};

renderSessions();
</script>
</body>
</html>
